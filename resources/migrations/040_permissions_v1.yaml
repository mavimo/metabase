databaseChangeLog:
  - changeSet:
      id: 40
      author: camsaul
      changes:
        ############################################################ add PermissionsGruop table ############################################################
        - createTable:
            tableName: permissions_group
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              # TODO - it would be nice to make this a case-insensitive unique constraint / index?
              - column:
                  name: name
                  type: varchar(256)
                  constraints:
                    nullable: false
                    unique: true
                    uniqueConstraintName: unique_permissions_group_name
        - createIndex:
            tableName: permissions_group
            indexName: idx_permissions_group_name
            columns:
              column:
                name: name
        ############################################################ add PermissionsGroupMembership table ############################################################
        - createTable:
            tableName: permissions_group_membership
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: user_id
                  type: int
                  constraints:
                    nullable: false
                    references: core_user(id)
                    foreignKeyName: fk_permissions_group_membership_user_id
              - column:
                  name: group_id
                  type: int
                  constraints:
                    nullable: false
                    references: permissions_group(id)
                    foreignKeyName: fk_permissions_group_group_id
        - addUniqueConstraint:
            tableName: permissions_group_membership
            columnNames: user_id, group_id
            constraintName: unique_permissions_group_membership_user_id_group_id
        # for things like all users in a given group
        - createIndex:
            tableName: permissions_group_membership
            indexName: idx_permissions_group_membership_group_id
            columns:
              column:
                name: group_id
        # for things like all groups a user belongs to
        - createIndex:
            tableName: permissions_group_membership
            indexName: idx_permissions_group_membership_user_id
            columns:
              column:
                name: user_id
        # for things like is given user a member of a given group (TODO - not sure we need this)
        - createIndex:
            tableName: permissions_group_membership
            indexName: idx_permissions_group_membership_group_id_user_id
            columns:
              column:
                name: group_id
              column:
                name: user_id
        ############################################################ add DatabasePermissions table ############################################################
        - createTable:
            tableName: database_permissions
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: group_id
                  type: int
                  constraints:
                    nullable: false
                    references: permissions_group(id)
                    foreignKeyName: fk_database_permissions_group_id
              - column:
                  name: database_id
                  type: int
                  constraints:
                    nullable: false
                    references: metabase_database(id)
                    foreignKeyName: fk_database_permissions_database_id
              - column:
                  name: unrestricted_schema_access
                  type: boolean
                  remarks: "Is this group allowed to access any schema in the database? (As opposed to having access to only a whitelisted subset of schemas.)"
                  constraints:
                    nullable: false
                  defaultValueBoolean: true
              - column:
                  name: native_query_write_access
                  type: boolean
                  remarks: "Does this group have permission to create/edit native queries? (Groups can run existing native queries created by others if they have permissions for the source database.)"
                  constraints:
                    nullable: false
                  defaultValueBoolean: true
        - addUniqueConstraint:
            tableName: database_permissions
            columnNames: group_id, database_id
        # for things like which databases does this group have access to
        - createIndex:
            tableName: database_permissions
            indexName: idx_database_permissions_group_id
            columns:
              column:
                name: group_id
        # for things like which groups have access for given DB
        - createIndex:
            tableName: database_permissions
            indexName: idx_database_permissions_database_id
            columns:
              column:
                name: database_id
        # for things like does a given group have access to a given DB. (TODO - not 100% sure we need this)
        - createIndex:
            tableName: database_permissions
            indexName: idx_database_permissions_group_id_database_id
            columns:
              column:
                name: group_id
              column:
                name: database_id
        ############################################################ add SchemaPermissions table ############################################################
        - createTable:
            tableName: schema_permissions
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: group_id
                  type: int
                  constraints:
                    nullable: false
                    references: permissions_group(id)
                    foreignKeyName: fk_schema_permissions_group_id
              - column:
                  name: database_id
                  type: int
                  constraints:
                    nullable: false
                    references: metabase_database(id)
                    foreignKeyName: fk_schema_permissions_database_id
              - column:
                  name: schema
                  type: varchar(256)
                  constraints:
                    nullable: false
                    # TODO - Is there an easy way to add a constraint to make sure this a valid schema for the given database?
              - column:
                  name: unrestricted_table_access
                  type: boolean
                  remarks: "Is this group allowed to access any table belonging to this schema? (As opposed to only having access to a whitelisted subset of tables.)"
                  constraints:
                    nullable: false
                  defaultValueBoolean: true
        - addUniqueConstraint:
            tableName: schema_permissions
            columnNames: group_id, database_id, schema
        # for things like which schemas a group has permissions for
        - createIndex:
            tableName: schema_permissions
            indexName: idx_schema_permissions_group_id
            columns:
              column:
                name: group_id
        # for things like which groups have access to a given database (TODO - not 100% sure we need this)
        - createIndex:
            tableName: schema_permissions
            indexName: idx_schema_permissions_database_id
            columns:
              column:
                name: database_id
        # for things like which groups have permissions for a schema
        - createIndex:
            tableName: schema_permissions
            indexName: idx_schema_permissions_database_id_schema
            columns:
              column:
                name: database_id
              column:
                name: schema
        ############################################################ add TablePermissions table ############################################################
        - createTable:
            tableName: table_permissions
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: group_id
                  type: int
                  constraints:
                    nullable: false
                    references: permissions_group(id)
                    foreignKeyName: fk_table_permissions_group_id
              - column:
                  name: table_id
                  type: int
                  constraints:
                    nullable: false
                    references: metabase_table(id)
                    foreignKeyName: fk_table_permissions_table_id
        - addUniqueConstraint:
            tableName: table_permissions
            columnNames: group_id, table_id
        # for things like seeing which tables a group has permissions for
        - createIndex:
            tableName: table_permissions
            indexName: idx_table_permissions_group_id
            columns:
              column:
                name: group_id
        # for seeing things like which group has permissions for a given table (TODO - do we need this?)
        - createIndex:
            tableName: table_permissions
            indexName: idx_table_permissions_table_id
            columns:
              column:
                name: table_id
        # for things like seeing if a given group has permissions for a given table
        - createIndex:
            tableName: table_permissions
            indexName: idx_table_permissions_group_id_table_id
            columns:
              column:
                name: group_id
              column:
                name: table_id
        ############################################################ Add indexes for table db_id + schema ############################################################
        # This is for doing things like getting all the tables that belong to a given schema
        - createIndex:
            tableName: metabase_table
            indexName: idx_metabase_table_db_id_schema
            columns:
              column:
                name: db_id
              column:
                name: schema
